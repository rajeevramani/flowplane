# Docker Compose for Flowplane with Secrets Management and Tracing
#
# This configuration provides:
# - Flowplane Control Plane with secrets management and tracing enabled
# - HashiCorp Vault for secrets backend (dev mode)
# - Jaeger for trace visualization (with native OTLP support)
# - httpbin for testing HTTP requests
#
# Usage:
#   docker-compose -f docker-compose-secrets-tracing.yml up
#
# Access:
#   - Flowplane API: http://localhost:8080
#   - Vault UI: http://localhost:8200 (token: flowplane-dev-token)
#   - Jaeger UI: http://localhost:16686
#   - httpbin: http://localhost:8000
#
# Environment Variables:
#   BOOTSTRAP_TOKEN: Auth token for Flowplane (min 32 chars)

services:
  # HashiCorp Vault for secrets management (dev mode)
  vault:
    image: hashicorp/vault:1.18
    container_name: flowplane-vault
    ports:
      - "8200:8200"  # Vault API and UI
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: flowplane-dev-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_LOG_LEVEL: info
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - flowplane-network
    command: server -dev

  # Jaeger for trace collection and visualization (with native OTLP support)
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: flowplane-jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - flowplane-network

  # Flowplane Control Plane with secrets and tracing enabled
  control-plane:
    image: ghcr.io/rajeevramani/flowplane:latest
    container_name: flowplane-control-plane
    environment:
      # Database configuration (SQLite)
      FLOWPLANE_DATABASE_URL: sqlite:///app/data/flowplane.db

      # Server configuration
      FLOWPLANE_API_BIND_ADDRESS: 0.0.0.0
      FLOWPLANE_API_PORT: 8080
      FLOWPLANE_XDS_BIND_ADDRESS: 0.0.0.0
      FLOWPLANE_XDS_PORT: 50051

      # Vault configuration
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: flowplane-dev-token

      # Logging
      RUST_LOG: info,flowplane=debug,flowplane::secrets=trace

      # Observability - Tracing ENABLED, pointing to Jaeger OTLP endpoint
      FLOWPLANE_ENABLE_METRICS: "true"
      FLOWPLANE_ENABLE_TRACING: "true"
      FLOWPLANE_OTLP_ENDPOINT: "http://jaeger:4317"
      FLOWPLANE_TRACE_SAMPLING_RATIO: "1.0"
      FLOWPLANE_SERVICE_NAME: "flowplane-control-plane"
      # Secrets encryption (enables SDS)
      FLOWPLANE_SECRET_ENCRYPTION_KEY: "d2t71S8xKUQqhaWbj1VofrH/Z8Dq4qR+hAcgXpP6Udg="
    ports:
      - "8080:8080"   # HTTP API
      - "50051:50051" # xDS gRPC
    depends_on:
      vault:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthcheck"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s
    volumes:
      - flowplane_data:/app/data
    networks:
      - flowplane-network
    restart: unless-stopped

  # httpbin for HTTP testing
  httpbin:
    image: kennethreitz/httpbin:latest
    container_name: flowplane-httpbin
    ports:
      - "8000:80"
    networks:
      - flowplane-network
    restart: unless-stopped

networks:
  flowplane-network:
    external: true

volumes:
  flowplane_data:
    driver: local
