name: oauth2
display_name: OAuth2 Authentication
description: OAuth2 authentication filter for protecting HTTP services with OAuth2/OIDC flows
version: "1.0"

envoy:
  http_filter_name: envoy.filters.http.oauth2
  type_url: type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
  # Note: OAuth2 does NOT support typed_per_filter_config
  # per_route_type_url is intentionally omitted

capabilities:
  attachment_points:
    - listener
  requires_listener_config: true
  # OAuth2 does NOT support per-route configuration in Envoy
  # Use pass_through_matcher instead to bypass OAuth2 for specific paths
  per_route_behavior: not_supported

is_implemented: true

config_schema:
  type: object
  required:
    - token_endpoint
    - authorization_endpoint
    - credentials
    - redirect_uri
  properties:
    token_endpoint:
      type: object
      description: Token endpoint configuration
      required:
        - uri
        - cluster
      properties:
        uri:
          type: string
          description: URI for the token endpoint
        cluster:
          type: string
          description: Cluster name for the token endpoint
          x-field-type: cluster_selector
        timeout_ms:
          type: integer
          description: Timeout in milliseconds
          default: 5000
          minimum: 1
    authorization_endpoint:
      type: string
      description: URL of the OAuth2 authorization endpoint
    credentials:
      type: object
      description: OAuth2 client credentials
      required:
        - client_id
      properties:
        client_id:
          type: string
          description: OAuth2 client ID
        token_secret:
          type: object
          description: Token secret configuration (delivered via SDS)
          required:
            - name
          properties:
            name:
              type: string
              description: Name of the SDS secret for the OAuth2 token
              x-field-type: secret_selector
              x-secret-type: generic_secret
        cookie_domain:
          type: string
          description: Domain for OAuth cookies
        cookie_names:
          type: object
          description: Custom cookie names
          properties:
            bearer_token:
              type: string
            oauth_hmac:
              type: string
            oauth_expires:
              type: string
            id_token:
              type: string
            refresh_token:
              type: string
    redirect_uri:
      type: string
      description: OAuth2 redirect URI (callback URL)
    redirect_path:
      type: string
      description: Path that handles the OAuth2 callback
      default: /oauth2/callback
    signout_path:
      type: string
      description: Path for signing out (clears OAuth cookies)
    auth_scopes:
      type: array
      description: OAuth2 scopes to request
      items:
        type: string
      default:
        - openid
        - profile
        - email
    auth_type:
      type: string
      enum:
        - url_encoded_body
        - basic_auth
      description: Client authentication method
      default: url_encoded_body
    forward_bearer_token:
      type: boolean
      description: Forward OAuth token to upstream as Bearer token
      default: true
    preserve_authorization_header:
      type: boolean
      description: Preserve existing authorization header
      default: false
    use_refresh_token:
      type: boolean
      description: Enable automatic token refresh using refresh tokens
      default: false
    default_expires_in_seconds:
      type: integer
      description: Default token expiration in seconds (if not provided by server)
      minimum: 1
    stat_prefix:
      type: string
      description: Stat prefix for metrics
    pass_through_matcher:
      type: array
      description: |
        Paths or headers to bypass OAuth2 authentication.
        Since Envoy's OAuth2 filter does NOT support per-route configuration,
        this is the ONLY way to make specific routes public without OAuth2.
      items:
        type: object
        properties:
          path_exact:
            type: string
            description: Exact path to bypass OAuth2 (e.g., "/healthz")
          path_prefix:
            type: string
            description: Path prefix to bypass OAuth2 (e.g., "/api/public/")
          path_regex:
            type: string
            description: Regex pattern to bypass OAuth2 (e.g., "^/static/.*")
          header_name:
            type: string
            description: Header name for custom bypass matching
          header_value:
            type: string
            description: Header value to match (used with header_name)
      x-ui-hint: |
        Add paths that should bypass OAuth2 authentication.
        Common examples: /healthz, /api/public/, /static/

# Note: per_route_config_schema is intentionally omitted because
# Envoy's OAuth2 filter does NOT support typed_per_filter_config.
# Envoy error: "The filter envoy.filters.http.oauth2 doesn't support
# virtual host or route specific configurations"
# Use pass_through_matcher instead.

ui_hints:
  form_layout: sections
  sections:
    - name: OAuth2 Provider
      fields:
        - authorization_endpoint
        - token_endpoint.uri
        - token_endpoint.cluster
        - token_endpoint.timeout_ms
      description: Configure the OAuth2 provider endpoints
    - name: Client Credentials
      fields:
        - credentials.client_id
        - credentials.token_secret
        - redirect_uri
        - redirect_path
      description: Client credentials and redirect configuration
    - name: Scopes & Authentication
      fields:
        - auth_scopes
        - auth_type
      collapsible: true
    - name: Token Handling
      fields:
        - forward_bearer_token
        - preserve_authorization_header
        - use_refresh_token
        - default_expires_in_seconds
      collapsible: true
    - name: Public Paths (Bypass OAuth2)
      fields:
        - pass_through_matcher
      description: |
        Configure paths that should bypass OAuth2 authentication.
        This is the only way to make routes public since OAuth2 does not support per-route configuration.
      collapsible: false
    - name: Advanced
      fields:
        - credentials.cookie_domain
        - credentials.cookie_names
        - signout_path
        - stat_prefix
      collapsible: true
