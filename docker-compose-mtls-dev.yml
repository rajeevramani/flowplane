# Docker Compose for mTLS Development
#
# Provides HashiCorp Vault for PKI certificate generation and Control Plane.
# Used for testing mTLS between Envoy proxies and Control Plane.
#
# Usage:
#   # 1. Create network (required - must exist before starting)
#   docker network create flowplane-network 2>/dev/null || true
#
#   # 2. Start Vault first
#   docker-compose -f docker-compose-mtls-dev.yml up -d vault
#
#   # 3. Setup Vault PKI and generate xDS server certs
#   ./scripts/setup-vault-pki.sh
#
#   # 4. Now start Control Plane (CP needs certs from step 3)
#   docker-compose -f docker-compose-mtls-dev.yml up -d --build control-plane
#
# Access:
#   - Flowplane UI + API: http://localhost:8080
#   - Swagger UI: http://localhost:8080/swagger-ui/
#   - Vault UI: http://localhost:8200 (token: flowplane-dev-token)
#   - xDS gRPC: localhost:50051
#
# Certificate Flow (see ADR-008):
#   1. Create a team and dataplane via API
#   2. Issue certificate via POST /api/v1/teams/{team}/proxy-certificates
#   3. Get Envoy config via GET /api/v1/teams/{team}/dataplanes/{name}/envoy-config

services:
  vault:
    image: hashicorp/vault:1.18
    container_name: flowplane-vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: flowplane-dev-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_LOG_LEVEL: info
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - flowplane-network
    command: server -dev

  postgres:
    image: postgres:17-alpine
    container_name: flowplane-postgres
    environment:
      POSTGRES_USER: flowplane
      POSTGRES_PASSWORD: flowplane
      POSTGRES_DB: flowplane
    ports:
      - "5432:5432"
    volumes:
      - flowplane-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flowplane"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - flowplane-network
    restart: unless-stopped

  control-plane:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flowplane-control-plane
    ports:
      - "8080:8080"   # UI + API
      - "50051:50051" # xDS
    environment:
      # Logging
      RUST_LOG: info,flowplane=debug
      RUST_BACKTRACE: 1

      # API Server
      FLOWPLANE_API_BIND_ADDRESS: 0.0.0.0
      FLOWPLANE_API_PORT: 8080

      # xDS Server
      FLOWPLANE_XDS_BIND_ADDRESS: 0.0.0.0
      FLOWPLANE_XDS_PORT: 50051

      # UI (served by backend)
      FLOWPLANE_UI_DIR: /app/ui/build

      # Database (PostgreSQL)
      FLOWPLANE_DATABASE_URL: postgresql://flowplane:flowplane@flowplane-postgres:5432/flowplane
      FLOWPLANE_DATABASE_AUTO_MIGRATE: "true"

      # Vault PKI Configuration (for issuing client certs)
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: flowplane-dev-token
      FLOWPLANE_VAULT_PKI_MOUNT_PATH: pki_int_proxies
      FLOWPLANE_VAULT_PKI_ROLE: envoy-proxy
      FLOWPLANE_SPIFFE_TRUST_DOMAIN: flowplane.local

      # xDS Server mTLS Configuration
      # These certs are generated by ./scripts/setup-vault-pki.sh
      FLOWPLANE_XDS_TLS_CERT_PATH: /app/certs/server/xds-server.pem
      FLOWPLANE_XDS_TLS_KEY_PATH: /app/certs/server/xds-server.key
      FLOWPLANE_XDS_TLS_CLIENT_CA_PATH: /app/certs/server/xds-ca.pem

      # Secret Encryption (for database-stored secrets)
      FLOWPLANE_SECRET_ENCRYPTION_KEY: dev-encryption-key-32-bytes-long!
    volumes:
      # Mount certificates generated by setup-vault-pki.sh
      - ./.local/certs:/app/certs:ro
    depends_on:
      vault:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/swagger-ui/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - flowplane-network

volumes:
  flowplane-pgdata:
    driver: local

networks:
  flowplane-network:
    external: true
