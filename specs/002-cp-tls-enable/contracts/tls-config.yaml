openapi: 3.0.3
info:
  title: Flowplane TLS Configuration Contract
  description: Contract specification for TLS configuration and validation
  version: 1.0.0

components:
  schemas:
    TlsConfig:
      type: object
      description: TLS configuration for admin API server
      properties:
        enabled:
          type: boolean
          description: Whether TLS termination is enabled
          default: false
        cert_path:
          type: string
          format: path
          description: Path to PEM certificate file
          example: "/etc/flowplane/tls/cert.pem"
        key_path:
          type: string
          format: path
          description: Path to PEM private key file
          example: "/etc/flowplane/tls/key.pem"
        chain_path:
          type: string
          format: path
          nullable: true
          description: Optional path to certificate chain file
          example: "/etc/flowplane/tls/chain.pem"
        bind_address:
          type: string
          format: ipv4
          description: IP address to bind TLS server
          default: "0.0.0.0"
          example: "0.0.0.0"
        port:
          type: integer
          minimum: 1
          maximum: 65535
          description: Port for TLS server
          default: 8443
          example: 8443
      required:
        - enabled
      if:
        properties:
          enabled:
            const: true
      then:
        required:
          - cert_path
          - key_path

    CertificateInfo:
      type: object
      description: Metadata extracted from TLS certificate
      properties:
        subject:
          type: string
          description: Certificate subject (CN, O, etc.)
          example: "CN=api.example.com,O=Example Corp"
        issuer:
          type: string
          description: Certificate issuer
          example: "CN=Example CA,O=Example Corp"
        not_before:
          type: string
          format: date-time
          description: Certificate validity start time
        not_after:
          type: string
          format: date-time
          description: Certificate validity end time
        serial_number:
          type: string
          description: Certificate serial number (hex)
          example: "1234567890ABCDEF"
        fingerprint:
          type: string
          description: SHA-256 fingerprint of certificate
          example: "sha256:ABC123...DEF789"
      required:
        - subject
        - issuer
        - not_before
        - not_after
        - serial_number
        - fingerprint

    TlsError:
      type: object
      description: TLS configuration or validation error
      properties:
        error_type:
          type: string
          enum:
            - configuration_error
            - certificate_error
            - key_error
            - mismatch_error
            - expiration_error
            - permission_error
            - io_error
          description: Type of TLS error
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error context
          properties:
            file_path:
              type: string
              description: File path related to error
            expected_format:
              type: string
              description: Expected file format
            permission_required:
              type: string
              description: Required file permission
            expiry_time:
              type: string
              format: date-time
              description: Certificate expiry time for expiration errors
        correlation_id:
          type: string
          description: Request correlation ID
      required:
        - error_type
        - message

    TlsStatus:
      type: object
      description: Current TLS configuration status
      properties:
        enabled:
          type: boolean
          description: Whether TLS is currently enabled
        certificate_info:
          $ref: '#/components/schemas/CertificateInfo'
          nullable: true
          description: Information about loaded certificate
        bind_address:
          type: string
          description: Address server is bound to
        port:
          type: integer
          description: Port server is listening on
        validation_time:
          type: string
          format: date-time
          description: When certificate was last validated
        expires_in_days:
          type: integer
          description: Days until certificate expires
      required:
        - enabled
        - bind_address
        - port

  examples:
    ValidTlsConfig:
      summary: Valid TLS configuration
      value:
        enabled: true
        cert_path: "/etc/flowplane/tls/cert.pem"
        key_path: "/etc/flowplane/tls/key.pem"
        chain_path: "/etc/flowplane/tls/chain.pem"
        bind_address: "0.0.0.0"
        port: 8443

    DisabledTlsConfig:
      summary: TLS disabled configuration
      value:
        enabled: false
        bind_address: "0.0.0.0"
        port: 8080

    CertificateExpiredError:
      summary: Certificate expiration error
      value:
        error_type: "expiration_error"
        message: "Certificate has expired"
        details:
          file_path: "/etc/flowplane/tls/cert.pem"
          expiry_time: "2024-12-31T23:59:59Z"
        correlation_id: "startup_001"

    FilePermissionError:
      summary: File permission error
      value:
        error_type: "permission_error"
        message: "Cannot read certificate file"
        details:
          file_path: "/etc/flowplane/tls/cert.pem"
          permission_required: "read (r--)"
        correlation_id: "startup_002"

    CertKeyMismatchError:
      summary: Certificate/key mismatch error
      value:
        error_type: "mismatch_error"
        message: "Certificate and private key do not match"
        details:
          file_path: "/etc/flowplane/tls/key.pem"
          expected_format: "PEM private key matching certificate"
        correlation_id: "startup_003"